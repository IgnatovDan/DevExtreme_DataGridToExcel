<!DOCTYPE html>
<html>
<head>
    <title>DevExtreme DataGrid to Excel / exceljs</title>

    <link rel="stylesheet" type="text/css" href="https://cdn3.devexpress.com/jslib/18.2.3/css/dx.common.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn3.devexpress.com/jslib/18.2.3/css/dx.light.css" />
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>    
    <script type="text/javascript" src="https://cdn3.devexpress.com/jslib/18.2.3/js/dx.all.debug.js"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/1.6.3/exceljs.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>

</head>
<body>
    <script>
        async function ExportToExcel(dxDataGrid, saveMode) {
            performance.clearMarks();
            performance.clearMeasures();
            performance.mark("ExportToExcel start");
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('sheet 42');
            const columns = dxDataGrid.getVisibleColumns();
            const headerRow = worksheet.addRow();
            for(let i = 0; i < columns.length; i++) {
                const cell = headerRow.getCell(i + 1);
                cell.value = columns[i].caption;
                cell.font = cell.font || {};
                cell.font.bold = true;
            }

            performance.mark("loadAll start");
            const sourceItems = await dxDataGrid.getController("data").loadAll();
            performance.mark("loadAll end");
            performance.measure("loadAll", "loadAll start", "loadAll end");
            console.log("loadAll: " + performance.getEntriesByName("loadAll")[0].duration);

            performance.mark("createCells start");
            for(let i = 0; i < sourceItems.length; i++) {
                const dataRow = worksheet.addRow();
                for(let j = 0; j < sourceItems[i].values.length; j++) {
                    const cell = dataRow.getCell(j + 1);
                    cell.value = sourceItems[i].values[j];

                    /*if(typeof cell.value === "string") {
                        cell.value = Number(cell.value);
                    } else {
                        cell.value = String(cell.value);
                    }*/

                    if((i + j) % 5 === 0) {
                        cell.font = cell.font || {};
                        cell.font.underline = true;
                    }                    
                    if((i + j) % 7 === 0) {
                        cell.font = cell.font || {};
                        cell.font.bold = true;
                    }
                    if((i + j) % 11 === 0) {
                        cell.font = cell.font || {};
                        cell.font.italic = true;
                    }

                    cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                    if((i + j) % 13 === 0) {
                        cell.fill = cell.fill || {};
                        cell.fill ={
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb:'FF' + (i+j)%99 + i%99 + '00' }
                        };
                    }
                }
            }

            performance.mark("createCells end");
            performance.measure("createCells", "createCells start", "createCells end");
            console.log("createCells: " + performance.getEntriesByName("createCells")[0].duration);

            if(saveMode === 'FileSaver') {
                performance.mark("writeBuffer start");
                workbook.xlsx.writeBuffer()
                .then(function(buffer) {
                    performance.mark("writeBuffer end");
                    performance.measure("writeBuffer", "writeBuffer start", "writeBuffer end");
                    console.log("writeBuffer: " + performance.getEntriesByName("writeBuffer")[0].duration);

                    performance.mark("saveAs start");
                    saveAs(new Blob([buffer], { type: 'application/octet-stream' }), 'test.xlsx');
                    performance.mark("saveAs end");
                    performance.measure("saveAs", "saveAs start", "saveAs end");
                    console.log("saveAs: " + performance.getEntriesByName("saveAs")[0].duration);

                    performance.mark("ExportToExcel end");
                    performance.measure("ExportToExcel", "ExportToExcel start", "ExportToExcel end");

                    console.log("ExportToExcel: " + performance.getEntriesByName("ExportToExcel")[0].duration);
                });
            }
            else {
                workbook.xlsx.writeBuffer()
                .then(function(buffer) {
                    //const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const blob = new Blob([buffer], { type: 'application/octet-stream' });
                    const url = window.URL.createObjectURL(blob);
                    const anchor = document.createElement('a');
                    anchor.href = url;
                    anchor.download = 'test.xlsx';
                    anchor.click();
                    window.URL.revokeObjectURL(url);
                });
            }
        }
    </script>

    <div class="ExportToExcel_FileSaver"></div>
    <div class="ExportToExcel_AnchorClick"></div>
    <div class="jsdxDataGrid">Loading....</div>
    <script>
        (function() {
            const dxDataGrid = new DevExpress.ui.dxDataGrid(document.querySelector('.jsdxDataGrid'), {
                columns: [
                    { dataField: "f1", width: 100 },
                    { dataField: "f2", width: 50 },
                    { dataField: "f3", width: 100 },
                    { dataField: "f4", width: 200 },
                ],
                showColumnHeaders: true,
                dataSource: [
                    {f1: 11, f2: 12, f3: "13", f4: 14 },
                    {f1: 21, f2: "asdf", f3: 23, f4: "24" },
                ],
                export: {
                    enabled: true,
                },
                onExporting: () => {
                    performance.mark("dxDataGrid_Export start");
                },
                onExported: () => {
                    performance.mark("dxDataGrid_Export end");
                    performance.measure("dxDataGrid_Export", "dxDataGrid_Export start", "dxDataGrid_Export end");
                    console.log("dxDataGrid_Export: " + performance.getEntriesByName("dxDataGrid_Export")[0].duration);
                },
            });

            new DevExpress.ui.dxButton(document.querySelector('.ExportToExcel_FileSaver'), {
                text: 'ExportToExcel_FileSaver',
                onClick: e => ExportToExcel(dxDataGrid, 'FileSaver')
            });
            new DevExpress.ui.dxButton(document.querySelector('.ExportToExcel_AnchorClick'), {
                text: 'ExportToExcel_AnchorClick',
                onClick: e => ExportToExcel(dxDataGrid, 'Anchor')
            });
        })();
    </script>
    
    <hr/><br/>
    <div class="jsdxDataGrid_performance_export"></div>
    <div class="jsdxDataGrid_performance">Loading....</div>
    <script>
        function getColumns() {
            let result = [];
            for(let i = 0; i < 50; i++) {
                result[i] = "f" + i;
            }
            return result;
        }
        function getDataSource() {
            let result = [];
            for(let i = 0; i < 20000; i++) {
                result[i] = {};
                for(let j = 0; j < 50; j++) {
                    if((i + j) % 3 === 0) {
                        result[i]["f" + j] = "row " + i + " cell " + j;
                    }
                    else {
                        result[i]["f" + j] = i + j;
                    }
                }
            }
            return result;
        }
        (function() {
            const dxDataGrid = new DevExpress.ui.dxDataGrid(document.querySelector('.jsdxDataGrid_performance'), {
                columns: getColumns(),
                showColumnHeaders: true,
                dataSource: getDataSource(),
                export: {
                    enabled: true,
                },
                onExporting: () => {
                    performance.mark("dxDataGrid_Export start");
                },
                onExported: () => {
                    performance.mark("dxDataGrid_Export end");
                    performance.measure("dxDataGrid_Export", "dxDataGrid_Export start", "dxDataGrid_Export end");
                    console.log("dxDataGrid_Export: " + performance.getEntriesByName("dxDataGrid_Export")[0].duration);
                },
            });

            new DevExpress.ui.dxButton(document.querySelector('.jsdxDataGrid_performance_export'), {
                text: 'Export',
                onClick: e => ExportToExcel(dxDataGrid, 'FileSaver')
            });
        })();
    </script>

    <hr/><br/>
    <div class="ExportToExcel_valueTypes"></div>
    <div class="jsdxDataGrid_valueTypes">Loading....</div>
    <script>
        (function() {
            const dxDataGrid = new DevExpress.ui.dxDataGrid(document.querySelector('.jsdxDataGrid_valueTypes'), {
                columns: [
                    { dataField: "f1", dataType: "string" },
                    { dataField: "f2", dataType: "number" },
                    { dataField: "f3", dataType: "date" },
                    { dataField: "f4", dataType: "boolean" },
                    { dataField: "f5", dataType: "object" },
                    { dataField: "f6", dataType: "datetime" },
                ],
                showColumnHeaders: true,
                dataSource: [
                    {f1: "11", f2: 123456789, f3: new Date(), f4: true, f5: { firstName: "Sam" }, f6: new Date() },
                    {f1: null, f2: null, f3: null, f4: null, f5: null, f6: null },
                    {f1: undefined, f2: undefined, f3: undefined, f4: undefined, f5: undefined, f6: undefined },
                ],
                export: {
                    enabled: true,
                },
            });

            new DevExpress.ui.dxButton(document.querySelector('.ExportToExcel_valueTypes'), {
                text: 'Export',
                onClick: e => ExportToExcel(dxDataGrid, 'FileSaver')
            });
        })();
    </script>

</body>
</html> 